#!/bin/bash
# =========================================
# โโโ      โโโ   โโโโโโโ   โโโโ โโโโโโ  โโโโโโโโโโโโโโ  โโโโโโ โโโโโโโโโโโโโโโโโ
# โโโ      โโโ   โโโโโโโโ โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
# โโโ      โโโ   โโโโโโโโโโโโโโโโโโโโโโโโโ     โโโโโโโโโโโโโโโโโโโโโโ     โโโ   
# โโโ      โโโ   โโโโโโโโโโโโโโโโโโโโโโโโโ     โโโโโโโโโโโโโโโโโโโโโโ     โโโ   
# โโโโโโโโ โโโโโโโโโโโโ โโโ โโโโโโ  โโโโโโโโโโโโโโ  โโโโโโ  โโโโโโ        โโโ   
# โโโโโโโโ  โโโโโโโ โโโ     โโโโโโ  โโโ โโโโโโโโโโ  โโโโโโ  โโโโโโ        โโโ   
#
#            โข By SrxMateo โข
# =========================================

# --- CONFIGURACIรN PROXY ---
SERVER_JAR="velocity.jar"       # Asegรบrate de que el archivo se llame asรญ
MEM_MIN="512M"                  # El proxy consume muy poco
MEM_MAX="1G"                    # Con 1G es mรกs que suficiente para +200 usuarios
SCREEN_NAME="LumaProxy"

# JVM flags optimizados para Velocity (Diferentes a los de Paper)
JVM_OPTS="-XX:+UseG1GC -XX:G1HeapRegionSize=4M -XX:+UnlockExperimentalVMOptions \
-XX:+ParallelRefProcEnabled -XX:+AlwaysPreTouch -XX:MaxGCPauseMillis=100"

# Colores
MAGENTA="\033[1;35m"
CYAN="\033[1;36m"
WHITE="\033[1;37m"
GREEN="\033[1;32m"
YELLOW="\033[1;33m"
RED="\033[1;31m"
RESET="\033[0m"

# 1. Detecciรณn de Java
JAVA_PATH=$(which java)
[ -z "$JAVA_PATH" ] && JAVA_PATH="/usr/lib/jvm/temurin-21-jdk-amd64/bin/java"

# --- BUCLE DE EJECUCIรN ---
while true; do
    clear
    echo -e "${MAGENTA}"
    echo " โโโ      โโโ   โโโโโโโ   โโโโ โโโโโโ  โโโโโโโโโโโโโโ  โโโโโโ โโโโโโโโโโโโโโโโโ"
    echo " โโโ      โโโ   โโโโโโโโ โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
    echo " โโโ      โโโ   โโโโโโโโโโโโโโโโโโโโโโโโโ     โโโโโโโโโโโโโโโโโโโโโโ     โโโ   "
    echo " โโโ      โโโ   โโโโโโโโโโโโโโโโโโโโโโโโโ     โโโโโโโโโโโโโโโโโโโโโโ     โโโ   "
    echo " โโโโโโโโ โโโโโโโโโโโโ โโโ โโโโโโ  โโโโโโโโโโโโโโ  โโโโโโ  โโโโโโ        โโโ   "
    echo " โโโโโโโโ  โโโโโโโ โโโ     โโโโโโ  โโโ โโโโโโโโโโ  โโโโโโ  โโโโโโ        โโโ   "
    echo -e "            ${WHITE}โข By SrxMateo โข${RESET}"
    echo ""
    echo -e "      ${CYAN}๐ INICIANDO VELOCITY PROXY ๐${RESET}"
    echo -e "      ${WHITE}Sesiรณn:${RESET} ${MAGENTA}$SCREEN_NAME${RESET} | ${WHITE}RAM:${RESET} ${MAGENTA}$MEM_MAX${RESET}"
    echo -e "${MAGENTA} ==========================================================================${RESET}"
    echo ""

    # Obtener RAM libre del sistema para info
    RAM_LIBRE=$(free -h | awk '/^Mem:/ {print $4}')
    echo -e "${WHITE}๐ RAM Libre en VPS:${RESET} ${GREEN}$RAM_LIBRE${RESET}"
    echo -e "${GREEN}๐ข El Proxy estรก recibiendo conexiones...${RESET}"
    echo ""

    # Ejecuciรณn de Java
    "$JAVA_PATH" -Xms$MEM_MIN -Xmx$MEM_MAX $JVM_OPTS -jar $SERVER_JAR

    echo -e "\n${RED}โ๏ธ EL PROXY SE HA CAรDO O CERRADO.${RESET}"
    echo -e "${WHITE}๐ Reiniciando el tรบnel de red en:${RESET}"
    
    for i in 5 4 3 2 1; do
        echo -n -e "${YELLOW}$i... ${RESET}"
        sleep 1
    done
    echo -e "\n"
done
